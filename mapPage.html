<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calgary Building Permits Map</title>
    <!-- Include Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="format.css">
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <!-- Date Range Picker -->
    <div class="container mt-4">
        <h4>Select Date Range:</h4>
        <div class="form-group">
            <label for="startDate">Start Date:</label>
            <input type="date" class="form-control" id="startDate">
        </div>
        <div class="form-group">
            <label for="endDate">End Date:</label>
            <input type="date" class="form-control" id="endDate">
        </div>
        <button class="btn btn-primary" id="searchButton">Search</button>
        <br><br>
        Use this web application to search a date range for building permits in the Calgary area, Upon searching locations
        will appear on the map, and are interactable giving you information about said permits!
    </div>


    <!-- Map -->

    


    <!-- Include Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Include Leaflet.markercluster JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/leaflet.markercluster.js"></script>
   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.js"></script>

    <script>
        // Initialize the map
        var map = L.map('map').setView([51.0447, -114.0719], 12);

        // Add base map layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Initialize OverlappingMarkerSpiderfier
        var oms = new OverlappingMarkerSpiderfier(map);

        // Function to search building permits within the specified date range
        function searchBuildingPermits(startDate, endDate) {
            console.log('Searching for permits from ' + startDate + ' to ' + endDate);

            var apiUrl = 'https://data.calgary.ca/resource/c2es-76ed.geojson?$where=issueddate > \'' + startDate + '\' and issueddate < \'' + endDate + '\'';

            // Fetch data from API and add markers to the map
            fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                console.log('Data fetched:', data);
                var markers = [];
                var oms = new OverlappingMarkerSpiderfier(map);

                data.features.forEach(feature => {
                    var coordinates = feature.geometry.coordinates.reverse(); // GeoJSON coordinates are [longitude, latitude]
                    var marker = L.marker(coordinates);

                    // Set marker description for the pop-up
                   // Set marker description for the popup
                    var popupContent = `
                        <strong>Issued Date:</strong> ${feature.properties.issueddate}<br>
                        <strong>Work Class Group:</strong> ${feature.properties.workclassgroup}<br>
                        <strong>Contractor Name:</strong> ${feature.properties.contractorname}<br>
                        <strong>Community Name:</strong> ${feature.properties.communityname}<br>
                        <strong>Original Address:</strong> ${feature.properties.originaladdress}
                    `;
                    marker.bindPopup(popupContent); // Bind popup to marker

                    // Add marker to the array
                    markers.push(marker);
                });
                // Add markers to map
                var markerCluster = L.markerClusterGroup();
                markerCluster.addLayers(markers);
                map.addLayer(markerCluster);
                oms.addLayer(marker);
            })
            .catch(error => console.error('Error fetching data:', error));
        }

        // Event listener for search button click
        document.getElementById('searchButton').addEventListener('click', function() {
            var startDate = document.getElementById('startDate').value;
            var endDate = document.getElementById('endDate').value;
            console.log('Search button clicked. Start Date:', startDate, 'End Date:', endDate);
            searchBuildingPermits(startDate, endDate);
        });

        

        // Initial search for building permits when the page loads
        var currentDate = new Date().toISOString().split('T')[0];
        searchBuildingPermits(currentDate, currentDate); // Search for permits issued today
    </script>
</body>
</html>
